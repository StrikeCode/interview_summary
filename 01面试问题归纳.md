## 项目专栏

### 你的WebServer程序代码量是多少？

3200行左右

---



### 你有测过你的webserver的并发数吗，怎么实现这一个并发量的，能不能继续提升？

我有对我的服务器基础框架程序测过其连接的并发数，测试环境是3台2g单核客户机，和1台4g双核的客户机。

最开始只能达到1024的并发数便停止增长，并且提示`Too many open files`于是我通过下方代码将客户机和服务器的linux系统参数`open files`（**最大打开文件数量**）从1024修改为1048576（即100M）

```sh
ulimit -n 1048576 # 临时修改
```



然后再进行测试，此时服务端并发数到达60000左右，三个客户端连接数分别为20000左右，停止增加出现` Connection timed out `错误。

此时查看`/proc/sys/fs/file-max`(最大文件数量)，超过1048576 (这个属性如果太小会出现 `Cannot open /proc/meminfo:Too many open files in system file-max` 的错误)。然后查看防火墙最大可跟踪的连接数（`nf_conntrack_max`）发现只有65536，便在 ` /etc/sysctl.conf`中修改4台机器的`nf_conntrack_max`至1048576。

但是此时发现，还是只能到60000左右的并发数，并且此时出现了 `Cannot assign requested address`错误，**即无法分配地址**。

​	 首先考虑是不能分配客户端地址还是服务器地址？考虑socket和地址的关系，根据socket可以找到一个五元组即**socket-->(远程IP，远程端口，本机IP，本机端口，协议)**,因为此时，我们客户端监听在一个端口上，即服务器的IP和端口固定（也就是远程IP和远程端口）**客户端上的本机IP地址固定，本机端口在0-65535之间分配（port字段 2字节）**，所以一台客户机最多只能建立65536个与服务器的socket。

​	于是，**考虑远程端口（即服务器端口）是否可以使用多个来监听**，客户机连接的时候，循环选择远程端口建立连接。这样就使得一台客户机与服务器socket最多可达65536 * 65536 个（超过34w）.

​	最后，我还将**每个tcp连接的读写缓冲区**（`net.ipv4.tcp_wmem`和`net.ipv4.tcp_wmem`）大小设置为1024，这样一个socket所需内存空间为2KB，100w个连接就大约需要2G的内存。

​	并且设置**TCP协议栈内存**，即 `net.ipv4.tcp_mem`属性，设置2G为`low`状态，3G为`pressure`模式，4G时禁止分配socket。

​	最终测试服务器可以建立100w的连接。





### 服务器编程框架

![image-20221227174036662](01面试问题归纳.assets/image-20221227174036662.png)

| 模块         | 单个服务器程序                                               | 服务器集群                   |
| ------------ | ------------------------------------------------------------ | ---------------------------- |
| IO处理单元   | 处理客户连接、读写网络数据                                   | 作为接入服务器、实现负载均衡 |
| 逻辑单元     | 业务进程或线程。分析并处理客户数据，然后将结果传递给IO处理单元或直接发送给客户端 | 逻辑服务器                   |
| 网络存储单元 | 本地数据库、文件或缓存                                       | 数据库服务器                 |
| 请求队列     | 各单元之间的通信方式。请求队列通常被实现为**池的一部分**     | 各服务器之间的永久TCP连接    |



线程池的组成是一个线程的容器，一个工作队列，



如果任务插入删除频繁，加锁导致开销增大，任务队列可以改进为无锁队列



### 如何使用无锁队列来做任务队列[TODO]



介绍一下这个项目(几乎是必问的)
定时器是怎么实现的？还有什么实现方式？
实现一个无锁队列(用原子操作)
eventfd是什么？有什么好处？
双缓冲区异步日志是什么？为什么要这样做？对这个日志系统有没有进行压力测试？
什么是优雅关闭连接？(就是read()到0，要透明的传递这个行为而不是直接暴力close())
epoll的边沿触发和水平触发有什么区别？(epoll的源码并不长，从源码的角度回答比较好)
epoll为什么高效，相比select和poll
HTTP报文都有哪些字段？
假如服务器要升级，又不想让用户感觉到服务器升级了，该怎么做？(其实就是不间断的提供服务，参考nginx的平滑升级)
有没有实现内存池？
一个请求到来具体的处理过程是怎样的？
线程的唤醒还有哪些方式？
怎么检查内存泄漏的？
用到了哪些智能指针和RAII机制，几种锁的区别是什么
任务队列是怎么实现的，除了加锁还有什么方式？
如何解决死锁？
怎么进行压测的？
为什么要用非阻塞io？
为什么要做这个项目？
Reactor模式是什么？



接下来要把这个webserver移动到云服务器上进行测试

### 多线程是如何应用到项目中的？

先是1个listenfd专用thread，每建立一个connfd就创建一个thread，但是创建开销大就用线程池，但是线程多任务少的时候锁开销大，于是改为无锁队列





---



### 大量socket断开连接时，cpu占用率突然上升如和解决问题